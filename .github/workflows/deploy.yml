name: CI/CD to Cloud Run

on:
  push:
    branches:
      - "*"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: fifth-honor-476010-u0
      REGION: asia-southeast1

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # 3Ô∏è‚É£ Setup Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 4Ô∏è‚É£ Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 5Ô∏è‚É£ Configure Docker for GCR
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      # 6Ô∏è‚É£ Set GCP project
      - name: Set GCP project
        run: gcloud config set project $PROJECT_ID

      # 7Ô∏è‚É£ Deploy Frontend (static backend URLs)
      - name: Build & Deploy Frontend
        run: |
          TAG=$(date +%s)
          echo "üîñ Using tag: $TAG"

          docker buildx build \
            -f ./peerprep/dockerfile \
            --platform linux/amd64 \
            --no-cache \
            -t gcr.io/$PROJECT_ID/peerprep:$TAG \
            --build-arg VITE_USER_SERVICE_URL=${{ secrets.USER_SERVICE_URL }} \
            --build-arg VITE_QUESTION_SERVICE_URL=${{ secrets.QUESTION_SERVICE_URL }} \
            --build-arg VITE_MATCHING_SERVICE_URL=${{ secrets.MATCHING_SERVICE_URL }} \
            ./peerprep \
            --push

          gcloud run deploy peerprep \
            --image=gcr.io/$PROJECT_ID/peerprep:$TAG \
            --platform managed \
            --region $REGION \
            --allow-unauthenticated

      # 8Ô∏è‚É£ Deploy Backends (static frontend URL)
      - name: Build & Deploy Backends
        run: |
          TAG=$(date +%s)
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          echo "Frontend URL: $FRONTEND_URL"

          SERVICES="user-service,question-service,matching-service"
          IFS=',' read -ra SRV <<< "$SERVICES"

          for SERVICE in "${SRV[@]}"; do
            echo "üöÄ Building $SERVICE..."
            docker buildx build \
              --platform linux/amd64 \
              --no-cache \
              -t gcr.io/$PROJECT_ID/$SERVICE:$TAG \
              ./$SERVICE \
              --push

            echo "‚òÅÔ∏è Deploying $SERVICE..."
            gcloud run deploy "$SERVICE" \
              --image=gcr.io/$PROJECT_ID/$SERVICE:$TAG \
              --platform managed \
              --region $REGION \
              --allow-unauthenticated \
              --set-env-vars FRONTEND_URL=$FRONTEND_URL
          done
