name: Deploy to Cloud Run

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-southeast1
  SERVICES: peerprep,user-service,question-service,matching-service,frontend

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Configure Docker authentication
        run: gcloud auth configure-docker gcr.io --quiet

      - name: Build and push Docker images
        run: |
          IFS=',' read -ra SRV <<< "$SERVICES"
          for SERVICE in "${SRV[@]}"; do
            echo "ðŸš€ Building $SERVICE..."
            docker build -t "gcr.io/$PROJECT_ID/$SERVICE:latest" "$SERVICE"
            docker push "gcr.io/$PROJECT_ID/$SERVICE:latest"
          done

      # ðŸ”§ Optional cleanup step (only needs to run once per service)
      - name: Clear old env vars (run once if switching to secrets)
        run: |
          IFS=',' read -ra SRV <<< "$SERVICES"
          for SERVICE in "${SRV[@]}"; do
            echo "ðŸ§¹ Clearing old env vars for $SERVICE..."
            gcloud run services update "$SERVICE" \
              --region="$REGION" \
              --clear-env-vars || true
          done

      - name: Deploy backend services (with secrets)
        run: |
          IFS=',' read -ra SRV <<< "$SERVICES"
          for SERVICE in "${SRV[@]}"; do
            if [[ "$SERVICE" != "frontend" ]]; then
              echo "ðŸš€ Deploying $SERVICE..."
              gcloud run deploy "$SERVICE" \
                --image="gcr.io/$PROJECT_ID/$SERVICE:latest" \
                --region="$REGION" \
                --platform=managed \
                --allow-unauthenticated \
                --set-secrets="MONGO_URI_MATCHING=MONGO_URI_MATCHING:latest,MONGO_URI_USER=MONGO_URI_USER:latest,REDIS_HOST=REDIS_HOST:latest,REDIS_PORT=REDIS_PORT:latest,JWT_SECRET=JWT_SECRET:latest,USER_SERVICE_URL=USER_SERVICE_URL:latest,QUESTION_SERVICE_URL=QUESTION_SERVICE_URL:latest,MATCHING_SERVICE_URL=MATCHING_SERVICE_URL:latest"
            fi
          done

      - name: Deploy frontend
        run: |
          echo "ðŸŒ Deploying frontend..."
          gcloud run deploy frontend \
            --image="gcr.io/$PROJECT_ID/frontend:latest" \
            --region="$REGION" \
            --platform=managed \
            --allow-unauthenticated \
            --set-secrets="VITE_BACKEND_URL=VITE_BACKEND_URL:latest"
