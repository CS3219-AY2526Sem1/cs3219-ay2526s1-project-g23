name: CI/CD to Cloud Run

on:
  push:
    branches:
      - "**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: fifth-honor-476010-u0
      REGION: asia-southeast1
      # Map GitHub secrets to environment variables
      MONGO_URI_MATCHING: ${{ secrets.MONGO_URI_MATCHING }}
      MONGO_URI_USER: ${{ secrets.MONGO_URI_USER }}
      REDIS_HOST: ${{ secrets.REDIS_HOST }}
      REDIS_PORT: ${{ secrets.REDIS_PORT }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      USER_SERVICE_URL: ${{ secrets.USER_SERVICE_URL }}
      QUESTION_SERVICE_URL: ${{ secrets.QUESTION_SERVICE_URL }}
      MATCHING_SERVICE_URL: ${{ secrets.MATCHING_SERVICE_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Set GCP project
        run: gcloud config set project $PROJECT_ID

      - name: Build & Deploy Services
        run: |
          SERVICES=("peerprep" "user-service" "question-service" "matching-service" "frontend")
          for SERVICE in "${SERVICES[@]}"; do
            echo "Building and deploying $SERVICE..."

            if [ "$SERVICE" = "frontend" ]; then
              # Frontend build with Vite environment variables
              docker buildx build \
                --platform linux/amd64 \
                -t gcr.io/$PROJECT_ID/$SERVICE:latest \
                --build-arg VITE_QUESTION_SERVICE_URL=$QUESTION_SERVICE_URL \
                --build-arg VITE_USER_SERVICE_URL=$USER_SERVICE_URL \
                --build-arg VITE_MATCHING_SERVICE_URL=$MATCHING_SERVICE_URL \
                ./peerprep \
                --push

              # Deploy frontend (no sensitive secrets)
              gcloud run deploy "$SERVICE" \
                --image=gcr.io/$PROJECT_ID/$SERVICE:latest \
                --platform managed \
                --region $REGION \
                --allow-unauthenticated

            else
              # Backend services
              docker buildx build \
                --platform linux/amd64 \
                -t gcr.io/$PROJECT_ID/$SERVICE:latest \
                ./$SERVICE \
                --push

              # Deploy backend with Secret Manager references
              gcloud run deploy "$SERVICE" \
                --image=gcr.io/$PROJECT_ID/$SERVICE:latest \
                --platform managed \
                --region $REGION \
                --allow-unauthenticated \
                --set-secrets MONGO_URI_MATCHING=MONGO_URI_MATCHING:latest \
                --set-secrets MONGO_URI_USER=MONGO_URI_USER:latest \
                --set-secrets REDIS_HOST=REDIS_HOST:latest \
                --set-secrets REDIS_PORT=REDIS_PORT:latest \
                --set-secrets JWT_SECRET=JWT_SECRET:latest \
                --set-secrets USER_SERVICE_URL=USER_SERVICE_URL:latest \
                --set-secrets QUESTION_SERVICE_URL=QUESTION_SERVICE_URL:latest \
                --set-secrets MATCHING_SERVICE_URL=MATCHING_SERVICE_URL:latest
          done
