name: CI/CD to Cloud Run

on:
  push:
    branches:
      - "*"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: fifth-honor-476010-u0
      REGION: asia-southeast1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Set GCP project
        run: gcloud config set project $PROJECT_ID

      # 1Ô∏è‚É£ Deploy Frontend and capture URL
      - name: Build & Deploy Frontend
        run: |
          TAG=$(date +%s)
          docker buildx build \
            -f ./peerprep/dockerfile \
            --platform linux/amd64 \
            --no-cache \
            -t gcr.io/$PROJECT_ID/peerprep:$TAG \
            --build-arg VITE_QUESTION_SERVICE_URL=${{ secrets.QUESTION_SERVICE_URL }} \
            --build-arg VITE_USER_SERVICE_URL=${{ secrets.USER_SERVICE_URL }} \
            --build-arg VITE_MATCHING_SERVICE_URL=${{ secrets.MATCHING_SERVICE_URL }} \
            ./peerprep \
            --push

          # Deploy and capture frontend URL
          FRONTEND_URL=$(gcloud run deploy peerprep \
            --image=gcr.io/$PROJECT_ID/peerprep:$TAG \
            --platform managed \
            --region $REGION \
            --allow-unauthenticated \
            --format="value(status.url)")

          echo "‚úÖ Frontend deployed at: $FRONTEND_URL"
          echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_ENV

      # 2Ô∏è‚É£ Deploy Backends and capture URLs
      - name: Build & Deploy Backends
        run: |
          TAG=$(date +%s)
          SERVICES="user-service,question-service,matching-service"
          IFS=',' read -ra SRV <<< "$SERVICES"

          for SERVICE in "${SRV[@]}"; do
            echo "üöÄ Building $SERVICE..."
            docker buildx build \
              --platform linux/amd64 \
              --no-cache \
              -t gcr.io/$PROJECT_ID/$SERVICE:$TAG \
              ./$SERVICE \
              --push

            # Deploy backend and capture URL
            SERVICE_URL=$(gcloud run deploy "$SERVICE" \
              --image=gcr.io/$PROJECT_ID/$SERVICE:$TAG \
              --platform managed \
              --region $REGION \
              --allow-unauthenticated \
              --set-env-vars FRONTEND_URL=$FRONTEND_URL \
              --format="value(status.url)")

            echo "$SERVICE deployed at $SERVICE_URL"
            # Export backend URL as env variable for other services if needed
            echo "${SERVICE^^}_URL=$SERVICE_URL" >> $GITHUB_ENV
          done

      # 3Ô∏è‚É£ Optional: Redeploy services that depend on backend URLs
      - name: Redeploy services with backend URLs
        run: |
          # For example, if frontend needs backend URLs as build args
          docker buildx build \
            -f ./peerprep/dockerfile \
            --platform linux/amd64 \
            --no-cache \
            -t gcr.io/$PROJECT_ID/peerprep:$TAG \
            --build-arg VITE_USER_SERVICE_URL=$USER_SERVICE_URL \
            --build-arg VITE_QUESTION_SERVICE_URL=$QUESTION_SERVICE_URL \
            --build-arg VITE_MATCHING_SERVICE_URL=$MATCHING_SERVICE_URL \
            ./peerprep \
            --push

          gcloud run deploy peerprep \
            --image=gcr.io/$PROJECT_ID/peerprep:$TAG \
            --platform managed \
            --region $REGION \
            --allow-unauthenticated \
            --set-env-vars USER_SERVICE_URL=$USER_SERVICE_URL,QUESTION_SERVICE_URL=$QUESTION_SERVICE_URL,MATCHING_SERVICE_URL=$MATCHING_SERVICE_URL
