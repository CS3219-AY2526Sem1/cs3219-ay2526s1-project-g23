name: CI/CD to Cloud Run

on:
  push:
    branches:
      - "*"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: fifth-honor-476010-u0
      REGION: asia-southeast1

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # 3Ô∏è‚É£ Setup Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 4Ô∏è‚É£ Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 5Ô∏è‚É£ Configure Docker for GCR
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      # 6Ô∏è‚É£ Set GCP project
      - name: Set GCP project
        run: gcloud config set project $PROJECT_ID

      # 7Ô∏è‚É£ Build & Deploy All Services
      - name: Build & Deploy Services
        env:
          MONGO_URI_MATCHING: ${{ secrets.MONGO_URI_MATCHING }}
          MONGO_URI_QUESTION: ${{ secrets.MONGO_URI_QUESTION }}
          MONGO_URI_USER: ${{ secrets.MONGO_URI_USER }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          USER_SERVICE_URL: ${{ secrets.USER_SERVICE_URL }}
          QUESTION_SERVICE_URL: ${{ secrets.QUESTION_SERVICE_URL }}
          MATCHING_SERVICE_URL: ${{ secrets.MATCHING_SERVICE_URL }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION: ${{ env.REGION }}
        run: |
          set -e

          # Timestamp tag to force fresh deploy
          TAG=$(date +%s)
          echo "üîñ Using image tag: $TAG"

          SERVICES="peerprep,user-service,question-service,matching-service"
          IFS=',' read -ra SRV <<< "$SERVICES"

          for SERVICE in "${SRV[@]}"; do
            echo "üöÄ Building $SERVICE..."

            if [ "$SERVICE" = "peerprep" ]; then
              # Frontend build
              DOCKERFILE_PATH=./peerprep/dockerfile
              BUILD_CONTEXT=./peerprep

              echo "üìÇ Build context: $BUILD_CONTEXT"
              echo "üìù Dockerfile: $DOCKERFILE_PATH"

              docker buildx build \
                -f $DOCKERFILE_PATH \
                --platform linux/amd64 \
                --no-cache \
                -t gcr.io/$PROJECT_ID/$SERVICE:$TAG \
                --build-arg VITE_QUESTION_SERVICE_URL=$QUESTION_SERVICE_URL \
                --build-arg VITE_USER_SERVICE_URL=$USER_SERVICE_URL \
                --build-arg VITE_MATCHING_SERVICE_URL=$MATCHING_SERVICE_URL \
                $BUILD_CONTEXT \
                --push

              # Debug: list contents of dist
              echo "üìÇ Listing /usr/share/nginx/html inside built frontend image:"
              docker run --rm gcr.io/$PROJECT_ID/$SERVICE:$TAG ls -R /usr/share/nginx/html

              # Deploy frontend to Cloud Run
              echo "‚òÅÔ∏è Deploying $SERVICE to Cloud Run..."
              gcloud run deploy "$SERVICE" \
                --image=gcr.io/$PROJECT_ID/$SERVICE:$TAG \
                --platform managed \
                --region $REGION \
                --allow-unauthenticated
            else
              # Backend build
              docker buildx build \
                --platform linux/amd64 \
                --no-cache \
                -t gcr.io/$PROJECT_ID/$SERVICE:$TAG \
                ./$SERVICE \
                --push

              ENV_VARS="MONGO_URI_MATCHING=$MONGO_URI_MATCHING,MONGO_URI_QUESTION=$MONGO_URI_QUESTION,MONGO_URI_USER=$MONGO_URI_USER,REDIS_HOST=$REDIS_HOST,REDIS_PORT=$REDIS_PORT,JWT_SECRET=$JWT_SECRET,USER_SERVICE_URL=$USER_SERVICE_URL,QUESTION_SERVICE_URL=$QUESTION_SERVICE_URL,MATCHING_SERVICE_URL=$MATCHING_SERVICE_URL"

              # Deploy backend with env vars
              echo "‚òÅÔ∏è Deploying $SERVICE to Cloud Run..."
              gcloud run deploy "$SERVICE" \
                --image=gcr.io/$PROJECT_ID/$SERVICE:$TAG \
                --platform managed \
                --region $REGION \
                --allow-unauthenticated \
                --set-env-vars "$ENV_VARS"
            fi
          done
